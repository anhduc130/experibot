<html>
  <head>
    <!--
    See https://docs.microsoft.com/en-us/javascript/api/@microsoft/teams-js/context?view=msteams-client-js-latest
    and https://docs.microsoft.com/en-us/microsoftteams/platform/task-modules-and-cards/task-modules/task-modules-bots
  -->
    <script src="https://statics.teams.cdn.office.net/sdk/v1.6.0/js/MicrosoftTeams.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 15px;
      }
    </style>
  </head>

  <body>
    <p>
      <h2>User information</h2>
      Id: <span id="userId"></span><br/>
      Name: <span id="userName"></span>
    </p>
    <p>
      <h2>Authentication</h2>
      <button id="authenticate">Authenticate to MSFT AAD</button></br>
      <button id="authenticateb2c">Authenticate to AAD B2C</button>
    </p>
    <p>
      <h2>Local storage & cookies</h2>
      <button id="setLocalStorage">Set localStorage</button>
      <span id="localStorageSpan"></span>
    </p>
    <button id="close">Close</button>

    <script>
      const parseJwt = (jwt) => {
        const parts = jwt.split(".");
        return {
          header: JSON.parse(atob(parts[0])),
          payload: JSON.parse(atob(parts[1])),
          signature: parts[2],
        };
      };
      const attachAuthButtons = (context) => {
        const authButton = document.getElementById("authenticate");
        const authButtonB2C = document.getElementById("authenticateb2c");
        const auth = (tenantId, clientId) => () => {
          microsoftTeams.authentication.authenticate({
            url: `${window.location.origin}/auth/auth.html?tenantId=${tenantId}&clientId=${clientId}`,
            width: 600,
            height: 535,
            successCallback: function (result) {
              const jwt = parseJwt(result.idToken);
              userId = document.getElementById("user");
              userId.innerHTML = `${result.result} You authenticated as ${jwt.payload.name}`;
            },
            failureCallback: function (reason) {
              handleAuthError(reason);
            },
          });
        };
        authButton.onclick = auth(context.tid, context.clientId);
        authButtonB2C.onclick = auth(
          "437426e6-c3c0-4806-8921-76bcdd4493c9",
          "0b0d52e1-edc0-41f2-87cc-5d2ef153e7b0"
        );
      };

      const attachCloseButton = () => {
        const close = document.getElementById("close");
        close.onclick = () => {
          // Task module closes on submitTask
          // https://stackoverflow.com/questions/62260918/ms-teams-taskmodule-close-the-window
          microsoftTeams.tasks.submitTask(null);
        };
      };

      const attachLocalStorageElements = () => {
        const setLocalStorageButton =
          document.getElementById("setLocalStorage");
        const localStorageSpan = document.getElementById("localStorageSpan");

        setLocalStorageButton.onclick = () => {
          localStorage.setItem(
            "myvalue",
            "Date was " + new Date().toISOString()
          );
          localStorageSpan.innerHTML =
            "Local storage is set to: " + localStorage.getItem("myvalue");
        };
        localStorageSpan.innerHTML =
          "Local storage is: " + localStorage.getItem("myvalue");
      };

      const fillUserFields = (context) => {
        const userId = document.getElementById("userId")
        const userName = document.getElementById("userName")
        userId.innerHTML = context.userObjectId
        userName.innerHTML = context.userPrincipalName
      }

      microsoftTeams.initialize(() => {
        microsoftTeams.getContext((context) => {
          attachAuthButtons(context);
          fillUserFields(context);
      });
      });
      attachCloseButton();
      attachLocalStorageElements();
    </script>
  </body>
</html>
